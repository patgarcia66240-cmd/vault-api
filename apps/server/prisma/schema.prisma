generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id           String     @id @default(cuid())
  email        String     @unique
  passwordHash String
  plan         String     @default("FREE")
  stripeId     String?    @unique
  apiKeys      ApiKey[]
  invoices     Invoice[]
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  @@map("users")
}

model ApiKey {
  id              String   @id @default(cuid())
  userId          String
  name            String
  provider        String   @default("CUSTOM") // CUSTOM, SUPABASE
  providerConfig  String?  // JSON pour config Supabase: {url, anonKey, serviceRoleKey}
  prefix          String
  last4           String
  encCiphertext   Bytes
  encNonce        Bytes
  hash            String   @unique
  revoked         Boolean  @default(false)
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("api_keys")
}

model Invoice {
  id              String   @id @default(cuid())
  userId          String
  stripeInvoiceId String   @unique
  amount          Int      // en centimes
  currency        String   @default("usd")
  status          String   // paid, open, void, draft, uncollectible
  invoicePdf      String?  // URL vers le PDF Stripe
  hostedInvoiceUrl String? // URL de la page de paiement
  description     String?
  periodStart     DateTime?
  periodEnd       DateTime?
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("invoices")
}
